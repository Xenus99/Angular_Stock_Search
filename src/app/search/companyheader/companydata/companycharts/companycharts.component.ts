import { Component } from '@angular/core';
import { GlobalVarsService } from '../../../../global-vars.service';

import * as Highcharts from 'highcharts/highstock';
import indicators from 'highcharts/indicators/indicators';
import vbp  from 'highcharts/indicators/volume-by-price';
indicators(Highcharts);
vbp(Highcharts);

@Component({
  selector: 'app-companycharts',
  templateUrl: './companycharts.component.html',
  styleUrl: './companycharts.component.css'
})

export class CompanychartsComponent {
    companyCharts: any;
    Highcharts: typeof Highcharts = Highcharts; // required
    chartOptions: Highcharts.Options = {};
    data: any;

    constructor(private globalVars: GlobalVarsService){

    }


    ngOnInit(){
        this.globalVars.getChartsDataMessage.subscribe(msg => this.companyCharts = msg);
        this.companyCharts = this.globalVars.getChartsData();
        // console.log(this.companyCharts.results);
        this.setCharts();
    }


    setCharts(){

        // Load the dataset
        // this.companyCharts = {"ticker":"AAPL","queryCount":124,"resultsCount":124,"adjusted":true,"results":[{"v":70790813,"vw":131.6292,"o":130.465,"c":130.15,"h":133.41,"l":129.89,"t":1673240400000,"n":645365},{"v":63896155,"vw":129.822,"o":130.26,"c":130.73,"h":131.2636,"l":128.12,"t":1673326800000,"n":554940},{"v":69458949,"vw":132.3081,"o":131.25,"c":133.49,"h":133.51,"l":130.46,"t":1673413200000,"n":561278},{"v":71379648,"vw":133.171,"o":133.88,"c":133.41,"h":134.26,"l":131.44,"t":1673499600000,"n":635331},{"v":57809719,"vw":133.6773,"o":132.03,"c":134.76,"h":134.92,"l":131.66,"t":1673586000000,"n":537385},{"v":63612627,"vw":135.7587,"o":134.83,"c":135.94,"h":137.29,"l":134.13,"t":1673931600000,"n":595831},{"v":69672800,"vw":136.3316,"o":136.815,"c":135.21,"h":138.61,"l":135.03,"t":1674018000000,"n":578304},{"v":58280413,"vw":134.9653,"o":134.08,"c":135.27,"h":136.25,"l":133.77,"t":1674104400000,"n":491674},{"v":80200655,"vw":136.3762,"o":135.28,"c":137.87,"h":138.02,"l":134.22,"t":1674190800000,"n":552230},{"v":81760313,"vw":141.2116,"o":138.12,"c":141.11,"h":143.315,"l":137.9,"t":1674450000000,"n":719288},{"v":66435142,"vw":142.0507,"o":140.305,"c":142.53,"h":143.16,"l":140.3,"t":1674536400000,"n":498679},{"v":65799349,"vw":140.7526,"o":140.89,"c":141.86,"h":142.43,"l":138.81,"t":1674622800000,"n":536505},{"v":54105068,"vw":143.3429,"o":143.17,"c":143.96,"h":144.25,"l":141.9,"t":1674709200000,"n":472135},{"v":70547743,"vw":145.8365,"o":143.155,"c":145.93,"h":147.23,"l":143.08,"t":1674795600000,"n":560022},{"v":64015274,"vw":143.6524,"o":144.955,"c":143,"h":145.55,"l":142.85,"t":1675054800000,"n":551111},{"v":65874459,"vw":143.6473,"o":142.7,"c":144.29,"h":144.34,"l":142.28,"t":1675141200000,"n":468170},{"v":77663426,"vw":143.8723,"o":143.97,"c":145.43,"h":146.61,"l":141.32,"t":1675227600000,"n":693374},{"v":118338980,"vw":149.3764,"o":148.9,"c":150.82,"h":151.18,"l":148.17,"t":1675314000000,"n":996203},{"v":154338835,"vw":154.2437,"o":148.03,"c":154.5,"h":157.38,"l":147.83,"t":1675400400000,"n":1141350},{"v":69771906,"vw":152.0939,"o":152.575,"c":151.73,"h":153.1,"l":150.78,"t":1675659600000,"n":583517},{"v":83322551,"vw":153.4202,"o":150.64,"c":154.65,"h":155.23,"l":150.64,"t":1675746000000,"n":661767},{"v":63620079,"vw":152.3636,"o":153.88,"c":151.92,"h":154.58,"l":151.168,"t":1675832400000,"n":524140},{"v":55994243,"vw":152.2769,"o":153.775,"c":150.87,"h":154.33,"l":150.42,"t":1675918800000,"n":471973},{"v":57388108,"vw":150.4054,"o":149.46,"c":151.01,"h":151.3401,"l":149.22,"t":1676005200000,"n":443405},{"v":62199013,"vw":153.231,"o":150.952,"c":153.85,"h":154.26,"l":150.92,"t":1676264400000,"n":506668},{"v":61664023,"vw":152.5956,"o":152.12,"c":153.2,"h":153.77,"l":150.86,"t":1676350800000,"n":528566},{"v":65665252,"vw":154.4536,"o":153.11,"c":155.33,"h":155.5,"l":152.88,"t":1676437200000,"n":520574},{"v":68167942,"vw":154.7143,"o":153.51,"c":153.71,"h":156.33,"l":153.3475,"t":1676523600000,"n":516187},{"v":59105618,"vw":152.0451,"o":152.35,"c":152.55,"h":153,"l":150.85,"t":1676610000000,"n":468580},{"v":58217230,"vw":149.3501,"o":150.2,"c":148.48,"h":151.3,"l":148.405,"t":1676955600000,"n":509342},{"v":51008155,"vw":148.5494,"o":148.87,"c":148.91,"h":149.95,"l":147.16,"t":1677042000000,"n":429775},{"v":48392049,"vw":148.8407,"o":150.09,"c":149.4,"h":150.34,"l":147.24,"t":1677128400000,"n":425159},{"v":55469606,"vw":146.3861,"o":147.11,"c":146.71,"h":147.19,"l":145.7202,"t":1677214800000,"n":472221},{"v":44998470,"vw":148.1344,"o":147.71,"c":147.92,"h":149.17,"l":147.45,"t":1677474000000,"n":418069},{"v":50546998,"vw":147.7996,"o":147.05,"c":147.41,"h":149.08,"l":146.83,"t":1677560400000,"n":383779},{"v":55478991,"vw":145.868,"o":146.83,"c":145.31,"h":147.2285,"l":145.01,"t":1677646800000,"n":461613},{"v":52279761,"vw":145.1652,"o":144.38,"c":145.91,"h":146.71,"l":143.9,"t":1677733200000,"n":413238},{"v":70725339,"vw":150.0304,"o":148.045,"c":151.03,"h":151.11,"l":147.33,"t":1677819600000,"n":558706},{"v":87558028,"vw":154.6895,"o":153.785,"c":153.83,"h":156.3,"l":153.46,"t":1678078800000,"n":691990},{"v":56136378,"vw":152.2768,"o":153.7,"c":151.6,"h":154.0299,"l":151.13,"t":1678165200000,"n":496631},{"v":47204791,"vw":152.6973,"o":152.81,"c":152.87,"h":153.47,"l":151.83,"t":1678251600000,"n":405203},{"v":53833122,"vw":152.4689,"o":153.559,"c":150.59,"h":154.535,"l":150.225,"t":1678338000000,"n":480909},{"v":68559600,"vw":149.0716,"o":150.21,"c":148.5,"h":150.94,"l":147.6096,"t":1678424400000,"n":611457},{"v":84457122,"vw":151.1835,"o":147.805,"c":150.47,"h":153.14,"l":147.7,"t":1678680000000,"n":760660},{"v":72045893,"vw":152.1061,"o":151.28,"c":152.59,"h":153.4,"l":150.1,"t":1678766400000,"n":565196},{"v":77167866,"vw":151.7861,"o":151.19,"c":152.99,"h":153.245,"l":149.92,"t":1678852800000,"n":703116},{"v":76206919,"vw":154.813,"o":152.16,"c":155.85,"h":156.46,"l":151.64,"t":1678939200000,"n":676097},{"v":98944633,"vw":155.3402,"o":156.08,"c":155,"h":156.74,"l":154.28,"t":1679025600000,"n":615778},{"v":72711415,"vw":156.6059,"o":155.07,"c":157.4,"h":157.82,"l":154.15,"t":1679284800000,"n":628984},{"v":73938285,"vw":158.3406,"o":157.32,"c":159.28,"h":159.4,"l":156.54,"t":1679371200000,"n":590982},{"v":75349311,"vw":159.6832,"o":159.3,"c":157.83,"h":162.14,"l":157.81,"t":1679457600000,"n":656865},{"v":67482060,"vw":159.5685,"o":158.83,"c":158.93,"h":161.5501,"l":157.68,"t":1679544000000,"n":614268},{"v":59006343,"vw":159.2417,"o":158.86,"c":160.25,"h":160.34,"l":157.85,"t":1679630400000,"n":517531},{"v":52390266,"vw":159.0188,"o":159.94,"c":158.28,"h":160.77,"l":157.87,"t":1679889600000,"n":518436},{"v":45992152,"vw":156.9785,"o":157.97,"c":157.65,"h":158.49,"l":155.98,"t":1679976000000,"n":432447},{"v":51305691,"vw":160.216,"o":159.37,"c":160.77,"h":161.05,"l":159.35,"t":1680062400000,"n":472077},{"v":49210289,"vw":162.0209,"o":161.53,"c":162.36,"h":162.47,"l":161.271,"t":1680148800000,"n":456152},{"v":68749792,"vw":164.0421,"o":162.44,"c":164.9,"h":165,"l":161.91,"t":1680235200000,"n":574409},{"v":56976187,"vw":165.3487,"o":164.27,"c":166.17,"h":166.29,"l":164.22,"t":1680494400000,"n":568686},{"v":46278295,"vw":165.9131,"o":166.595,"c":165.63,"h":166.84,"l":165.11,"t":1680580800000,"n":456306},{"v":51511744,"vw":163.4912,"o":164.74,"c":163.76,"h":165.05,"l":161.8,"t":1680667200000,"n":533621},{"v":45390123,"vw":164.0257,"o":162.43,"c":164.66,"h":164.9584,"l":162,"t":1680753600000,"n":446212},{"v":47670382,"vw":161.2628,"o":161.42,"c":162.03,"h":162.03,"l":160.08,"t":1681099200000,"n":563913},{"v":47494217,"vw":161.1314,"o":162.35,"c":160.8,"h":162.36,"l":160.51,"t":1681185600000,"n":490479},{"v":50133062,"vw":160.8845,"o":161.22,"c":160.1,"h":162.06,"l":159.78,"t":1681272000000,"n":514261},{"v":68418649,"vw":164.3531,"o":161.63,"c":165.56,"h":165.8,"l":161.42,"t":1681358400000,"n":595709},{"v":49314480,"vw":165.0394,"o":164.59,"c":165.21,"h":166.32,"l":163.82,"t":1681444800000,"n":489551},{"v":41516217,"vw":164.8044,"o":165.09,"c":165.23,"h":165.39,"l":164.03,"t":1681704000000,"n":483388},{"v":49915508,"vw":166.3535,"o":166.1,"c":166.47,"h":167.41,"l":165.65,"t":1681790400000,"n":494642},{"v":47621166,"vw":167.2806,"o":165.8,"c":167.63,"h":168.16,"l":165.54,"t":1681876800000,"n":473866},{"v":52456377,"vw":166.779,"o":166.09,"c":166.65,"h":167.87,"l":165.56,"t":1681963200000,"n":493153},{"v":57736141,"vw":165.0754,"o":165.05,"c":165.02,"h":166.4521,"l":164.49,"t":1682049600000,"n":520279},{"v":41449581,"vw":164.9397,"o":165,"c":165.33,"h":165.6,"l":163.89,"t":1682308800000,"n":459499},{"v":48652863,"vw":164.6479,"o":165.19,"c":163.77,"h":166.305,"l":163.73,"t":1682395200000,"n":501548},{"v":45487296,"vw":163.9084,"o":163.055,"c":163.76,"h":165.28,"l":162.8,"t":1682481600000,"n":493403},{"v":64898729,"vw":167.3197,"o":165.19,"c":168.41,"h":168.56,"l":165.19,"t":1682568000000,"n":575981},{"v":55275851,"vw":168.9479,"o":168.49,"c":169.68,"h":169.85,"l":167.8801,"t":1682654400000,"n":527763},{"v":52424936,"vw":169.6586,"o":169.28,"c":169.59,"h":170.45,"l":168.64,"t":1682913600000,"n":540745},{"v":48425696,"vw":168.6978,"o":170.09,"c":168.54,"h":170.35,"l":167.54,"t":1683000000000,"n":509755},{"v":65126998,"vw":169.013,"o":169.5,"c":167.45,"h":170.92,"l":167.16,"t":1683086400000,"n":610052},{"v":81225673,"vw":166.0983,"o":164.89,"c":165.79,"h":167.04,"l":164.31,"t":1683172800000,"n":832121},{"v":113402971,"vw":173.3116,"o":170.975,"c":173.57,"h":174.3,"l":170.76,"t":1683259200000,"n":915977},{"v":55962634,"vw":173.321,"o":172.48,"c":173.5,"h":173.85,"l":172.11,"t":1683518400000,"n":563138},{"v":45326874,"vw":172.3162,"o":173.05,"c":171.77,"h":173.54,"l":171.6,"t":1683604800000,"n":456209},{"v":53724501,"vw":173.1737,"o":173.02,"c":173.555,"h":174.03,"l":171.9,"t":1683691200000,"n":511486},{"v":49473076,"vw":173.4903,"o":173.85,"c":173.75,"h":174.59,"l":172.17,"t":1683777600000,"n":501955},{"v":45533138,"vw":172.3696,"o":173.62,"c":172.57,"h":174.06,"l":171,"t":1683864000000,"n":490533},{"v":37264259,"vw":172.1109,"o":173.16,"c":172.07,"h":173.21,"l":171.47,"t":1684123200000,"n":444785},{"v":42110293,"vw":172.2781,"o":171.99,"c":172.07,"h":173.1383,"l":171.7991,"t":1684209600000,"n":436165},{"v":57934404,"vw":171.85,"o":171.71,"c":172.69,"h":172.925,"l":170.4201,"t":1684296000000,"n":554940},{"v":65496657,"vw":174.3014,"o":173,"c":175.05,"h":175.24,"l":172.58,"t":1684382400000,"n":595692},{"v":55525641,"vw":175.5191,"o":176.39,"c":175.16,"h":176.39,"l":174.94,"t":1684468800000,"n":532731},{"v":43570932,"vw":174.1828,"o":173.98,"c":174.2,"h":174.71,"l":173.45,"t":1684728000000,"n":526393},{"v":50745163,"vw":172.1908,"o":173.13,"c":171.56,"h":173.3794,"l":171.275,"t":1684814400000,"n":535091},{"v":43711588,"vw":171.5088,"o":171.09,"c":171.84,"h":172.4183,"l":170.52,"t":1684900800000,"n":492275},{"v":55889523,"vw":172.8818,"o":172.41,"c":172.99,"h":173.895,"l":171.69,"t":1684987200000,"n":534909},{"v":54834975,"vw":175.1454,"o":173.32,"c":175.43,"h":175.77,"l":173.11,"t":1685073600000,"n":529918},{"v":55963954,"vw":177.4489,"o":176.96,"c":177.3,"h":178.99,"l":176.57,"t":1685419200000,"n":651318},{"v":99625288,"vw":177.9376,"o":177.325,"c":177.25,"h":179.35,"l":176.76,"t":1685505600000,"n":669221},{"v":68901712,"vw":179.3796,"o":177.7,"c":180.09,"h":180.12,"l":176.9306,"t":1685592000000,"n":624132},{"v":61996852,"vw":180.6479,"o":181.03,"c":180.95,"h":181.78,"l":179.26,"t":1685678400000,"n":617235},{"v":121722517,"vw":182.1408,"o":182.63,"c":179.58,"h":184.951,"l":178.035,"t":1685937600000,"n":1286180},{"v":64845314,"vw":178.7093,"o":179.965,"c":179.21,"h":180.12,"l":177.43,"t":1686024000000,"n":705164},{"v":61944615,"vw":178.6619,"o":178.44,"c":177.82,"h":181.21,"l":177.32,"t":1686110400000,"n":669062},{"v":50210681,"vw":179.5493,"o":177.895,"c":180.57,"h":180.84,"l":177.46,"t":1686196800000,"n":548456},{"v":48869360,"vw":181.4395,"o":181.5,"c":180.96,"h":182.23,"l":180.63,"t":1686283200000,"n":557894},{"v":54754995,"vw":182.836,"o":181.27,"c":183.79,"h":183.89,"l":180.97,"t":1686542400000,"n":562058},{"v":54867129,"vw":183.1702,"o":182.8,"c":183.31,"h":184.15,"l":182.44,"t":1686628800000,"n":608337},{"v":57462782,"vw":183.7101,"o":183.37,"c":183.95,"h":184.39,"l":182.02,"t":1686715200000,"n":614097},{"v":65433166,"vw":185.5672,"o":183.96,"c":186.01,"h":186.52,"l":183.78,"t":1686801600000,"n":697003},{"v":101151225,"vw":185.4644,"o":186.73,"c":184.92,"h":186.99,"l":184.27,"t":1686888000000,"n":616272},{"v":49799092,"vw":185.2709,"o":184.41,"c":185.01,"h":186.1,"l":184.41,"t":1687233600000,"n":577495},{"v":49515697,"vw":184.0809,"o":184.9,"c":183.96,"h":185.41,"l":182.5901,"t":1687320000000,"n":520855},{"v":51245327,"vw":186.1166,"o":183.74,"c":187,"h":187.045,"l":183.67,"t":1687406400000,"n":563076},{"v":53112346,"vw":186.4952,"o":185.55,"c":186.68,"h":187.56,"l":185.01,"t":1687492800000,"n":539704},{"v":48088661,"vw":186.3292,"o":186.83,"c":185.27,"h":188.05,"l":185.23,"t":1687752000000,"n":584497},{"v":50731499,"vw":187.4998,"o":185.89,"c":188.06,"h":188.39,"l":185.67,"t":1687838400000,"n":511869},{"v":51216801,"vw":188.8916,"o":187.93,"c":189.25,"h":189.9,"l":187.6,"t":1687924800000,"n":559145},{"v":46347308,"vw":189.5561,"o":189.08,"c":189.59,"h":190.07,"l":188.94,"t":1688011200000,"n":525367},{"v":85068452,"vw":193.102,"o":191.63,"c":193.97,"h":194.48,"l":191.26,"t":1688097600000,"n":774380},{"v":31458198,"vw":192.6624,"o":193.78,"c":192.46,"h":193.88,"l":191.76,"t":1688356800000,"n":500175},{"v":46896861,"vw":191.5803,"o":191.565,"c":191.33,"h":192.98,"l":190.62,"t":1688529600000,"n":560170},{"v":45155523,"vw":190.8214,"o":189.84,"c":191.81,"h":192.02,"l":189.2,"t":1688616000000,"n":562755},{"v":46757498,"vw":191.4218,"o":191.41,"c":190.68,"h":192.67,"l":190.24,"t":1688702400000,"n":538826}],"status":"OK","request_id":"59d6a73a99b76c643a88eec788fc93c1","count":124}

        const data = this.companyCharts.results;
        // split the data set into ohlc and volume
        const ohlc = [],
            volume = [],
            dataLength = data.length;
            // set the allowed units for data grouping

        for (let i = 0; i < dataLength; i += 1) {
            ohlc.push([
                data[i].t, // the date
                data[i].o, // open
                data[i].h, // high
                data[i].l, // low
                data[i].c // close
            ]);

            volume.push([
                data[i].t, // the date
                data[i].v // the volume
            ]);
        }
        // console.log(ohlc);
        // console.log(volume);
        // console.log(this.chartOptions)
        this.setChartOptions(ohlc, volume)
    }


    setChartOptions(ohlc, volume){

        this.chartOptions = {
            rangeSelector: {
                selected: 2
            },

            title: {
                text: this.companyCharts.ticker + ' Historical'
            },

            subtitle: {
                text: 'With SMA and Volume by Price technical indicators'
            },

            yAxis: [{
                startOnTick: false,
                endOnTick: false,
                labels: {
                    align: 'right', // Aligning labels to the right
                    x: -3
                },
                title: {
                    text: 'OHLC'
                },
                height: '60%',
                lineWidth: 2,
                resize: {
                    enabled: true
                },
                opposite: true
            }, {
                labels: {
                    align: 'right',
                    x: -3
                },
                title: {
                    text: 'Volume'
                },
                top: '65%',
                height: '35%',
                offset: 0,
                lineWidth: 2,
                opposite: true
            }],
            xAxis:{
                type: 'datetime'
            },

            tooltip: {
                split: true
            },

            plotOptions: {
                series: {
                    dataGrouping: {
                        enabled: false
                    }
                }
            },

            legend: {
                enabled: false // Disable legend
            },

            series: [{
                type: 'candlestick',
                name: this.companyCharts.ticker,
                id: 'aapl',
                zIndex: 2,
                data: ohlc
            }, {
                type: 'column',
                name: 'Volume',
                id: 'volume',
                data: volume,
                yAxis: 1
            }, {
                type: 'vbp',
                linkedTo: 'aapl',
                params: {
                    volumeSeriesID: 'volume'
                },
                dataLabels: {
                    enabled: false
                },
                zoneLines: {
                    enabled: false
                }
            }, {
                type: 'sma',
                linkedTo: 'aapl',
                zIndex: 1,
                marker: {
                    enabled: false
                }
            }]
        };

    }

    // create the chart




}
